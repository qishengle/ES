## ES 地理位置
***
ES 表示地理位置有两种类型：geo-point, geo-shape
***
geohash只是空间索引的一种方式，特别适合点数据，而对线、面数据采用R树索引更有优势。
从数学上讲geohash本质上是Peano空间填充曲线，将二维空间降维成分形曲线，此分形曲线能保持一定的空间局部性，从而可以用于排序。![peano](./images/1534748473838.png)
![二维坐标向一维坐标的转化过程](./images/1534748848369.png)
Peano曲线突变比较厉害，空间局部性不是特别好，相比之下Hilbert空间填充曲线空间局部性非常不错.![hilbert](./images/1534748375399.png)

> 地理坐标点不能被动态映射 （dynamic mapping）自动检测，而是需要显式声明对应字段类型为 geo-point

 经纬度信息的形式可以是字符串(字符串形式以半角逗号分割，如 "lat,lon")、数组或者对象.
 
 *用字符串形式表示时是纬度在前，经度在后（ "latitude,longitude" ），而数组形式表示时是经度在前，纬度在后. Elasticesearch 内部，不管字符串形式还是数组形式，都是经度在前，纬度在后。*
 
### 通过地理坐标点过滤
有四种地理坐标点相关的过滤器 可以用来选中或者排除文档：
**geo_bounding_box**
找出落在指定矩形框中的点。 
通常使用矩形模型 bounding box 是比地理距离更高效的方式，并且往往也能满足应用需求。
两点间的距离计算，有多种牺牲性能换取精度的算法，distance_type字段指定：
 - arc
  最慢但最精确的是 arc 计算方式，这种方式把世界当作球体来处理。
  
- plane
计算方式把地球当成是平坦的，这种方式快但是精度略逊。在赤道附近的位置精度最好，而靠近两极则变差。
- sloppy_arc 
默认的计算方式。比 arc 计算方式快 4 到 5 倍，并且距离精度达 99.9%。
> 大部分实际应用场景中，使用精度较低但响应更快的计算方式可能更好。

**geo_distance**
找出与指定位置在给定距离内的点。 
**geo_distance_range** 
找出与指定点距离在给定最小距离和最大距离之间的点。 
**geo_polygon**
找出落在多边形中的点。 这个过滤器使用代价很大 。当你需要使用它，最好使用 [geo-shapes](https://www.elastic.co/guide/cn/elasticsearch/guide/current/geo-shapes.html) 。
  `Geo-shapes 不能用于计算距离、排序、打分以及聚合`
> 地理坐标过滤器使用代价昂贵,先过滤掉尽可能多的文档，最后才交给地理坐标过滤器处理。

geohash 的长度越长，它的精度就越高. 

*精度* （ precision ）参数 用来控制生成的 geohash 的最大长度。默认精度为 9 ，等同于尺寸在 5m x 5m 的geohash

*距离误差* 指定地理形状可以接受的最大错误率。它的默认值是 0.025 ， 即 2.5% 。也就是说，大的地理形状（比如国家）相比小的地理形状（比如纪念碑）来说，容许更加模糊的边界

